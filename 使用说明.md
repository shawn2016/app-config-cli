# 商户app 工具 - 使用说明

## 📖 工具简介

**商户app 工具** 是一个可视化的品牌配置管理工具，用于统一管理和生成 UniApp 多品牌应用的配置文件。通过 Web 界面，可以轻松创建、编辑和管理不同品牌的配置信息，支持云打包、生成 App Links、生成云函数等功能。

## 🎯 主要作用

1. **统一管理多品牌配置**：集中管理所有品牌的配置信息，避免配置分散和遗漏
2. **可视化配置界面**：通过 Web 界面操作，无需手动编辑配置文件
3. **自动化云打包**：支持一键云打包，自动切换 Git 分支、更新版本号
4. **生成 App Links**：自动生成 iOS App Links 配置
5. **生成云函数**：自动生成 UniPush 云函数配置
6. **文件管理**：统一管理 Logo、证书、其他配置文件

## 🚀 快速开始

### 1. 安装工具

```bash
# 全局安装（推荐）
npm install -g app-config-cli

# 或本地开发模式
cd app-config-cli
npm install
npm run build
```

### 2. 查看版本和帮助

```bash
# 查看版本号
app-config --version
# 或
app-config -v

# 查看帮助信息
app-config --help
# 或
app-config -h

# 查看 serve 命令的帮助
app-config serve --help
```

### 3. 启动服务

在**项目根目录**（包含 `appConfig` 文件夹的目录）执行：

```bash
# 启动服务（默认端口 3000）
app-config serve

# 或指定端口
app-config serve --port 8080
```

启动后会自动打开浏览器，显示可视化配置页面。

### 4. 更新工具

```bash
# 更新到最新版本
npm install -g app-config-cli@latest

# 查看当前版本
app-config --version

# 查看可用版本
npm view app-config-cli versions
```

### 5. 在 mp-eatwell 项目中使用

如果需要在 `mp-eatwell` 项目中调试使用，可以在 `mp-eatwell/package.json` 中添加脚本：

```json
{
  "scripts": {
    "config:serve": "node ../../02-dzx/app-config-cli/bin/app-config.js serve",
    "config:dev": "cd ../../02-dzx/app-config-cli && npm run dev"
  }
}
```

然后执行：
```bash
npm run config:serve
```

## 📋 主要功能

### 1. 新建应用配置

- **步骤 1：基础信息**
  - 品牌别名（唯一标识）
  - 应用名称、英文名、描述
  - DCloud App ID
  - API 地区（US/SEA/EU/Test）

- **步骤 2：版本和证书**
  - 版本号、构建号
  - 上传 Logo 图片
  - 上传 iOS 证书（.p12 和 .mobileprovision）
  - 上传 Android 签名文件（.keystore）

- **步骤 3：其他配置**
  - Team ID、集团 ID、装修 ID
  - 其他配置文件（AuthKey、google-services.json 等）

### 2. 应用列表管理

- **查看配置**：列表/卡片两种视图模式
- **搜索过滤**：按品牌名、应用名、环境等搜索
- **编辑配置**：修改配置信息、上传/删除文件
- **删除配置**：删除不需要的品牌配置
- **配置字段**：自定义显示字段，支持全选/恢复默认

### 3. 云打包功能

- **选择平台**：Android 或 iOS
- **选择环境**：测试环境或生产环境（根据配置自动判断）
- **Git 分支管理**：
  - 自动获取可用分支列表
  - 支持切换分支（自动执行 `git checkout`、`git pull`、`pnpm i`）
  - 保存默认分支（按品牌+平台+环境组合）
- **版本管理**：
  - 自动递增构建号
  - 支持自定义版本号
- **操作类型**：
  - 云打包：完整的云打包流程
  - 制作 wgt 文件：仅生成 wgt 文件

### 4. 全局功能

- **生成 App Links**：为所有品牌生成 iOS App Links 配置
- **生成云函数**：生成 UniPush 云函数配置

## 👥 用户角色

工具支持两种用户角色：

- **开发人员**：拥有所有功能权限
  - 创建新应用
  - 编辑配置
  - 云打包
  - 生成 App Links
  - 生成云函数

- **测试人员**：仅限云打包功能
  - 查看应用列表
  - 执行云打包
  - 配置显示字段

## 📁 目录结构

工具会在项目根目录下创建/管理 `appConfig` 文件夹：

```
appConfig/
├── index.ts                    # 自动维护的配置文件索引
├── types.ts                    # 类型定义
├── {品牌别名}/
│   ├── index.ts               # 品牌配置文件
│   ├── logo.png               # Logo 图片
│   ├── {品牌别名}.keystore    # Android 签名文件
│   ├── certificate/           # iOS 证书目录
│   │   ├── dev/              # 开发环境证书
│   │   └── prod/             # 生产环境证书
│   │       ├── app.p12
│   │       └── app.mobileprovision
│   └── other/                 # 其他配置文件
│       ├── AuthKey_xxx.p8
│       └── google-services.json
```

## 🔧 常见操作

### 创建新品牌配置

1. 点击「新建应用」标签
2. 填写基础信息（品牌别名、应用名称等）
3. 上传 Logo 和证书文件
4. 填写其他配置信息
5. 预览确认后提交

### 执行云打包

1. 在应用列表中找到目标品牌
2. 点击「云打包」按钮
3. 选择平台（Android/iOS）
4. 选择 Git 分支（可选）
5. 确认版本号信息
6. 点击「开始打包」

### 编辑配置

1. 在应用列表中点击「编辑」
2. 修改配置信息
3. 上传/删除文件
4. 保存更改

### 生成 App Links

1. 确保所有品牌都配置了 `teamId` 和 `logo`
2. 点击顶部的「生成 applinks」按钮
3. 确认后自动生成所有品牌的 App Links 配置

## ⚠️ 注意事项

1. **工作目录**：必须在项目根目录执行命令，工具会在当前目录查找 `appConfig` 文件夹
2. **Git 分支**：云打包时会自动切换分支，请确保本地没有未提交的重要更改
3. **版本号**：版本号文件会在切换分支和 `git pull` 之后才更新，避免冲突
4. **证书文件**：iOS 证书需要手动上传，Android keystore 可以自动生成
5. **环境变量**：云打包时通过环境变量传递品牌信息，无需手动选择

## 🐛 故障排查

### 云打包卡住

- 检查是否设置了环境变量 `BRAND`
- 确保 `SKIP_CONFIRM=true` 已设置
- 查看日志输出，确认卡在哪一步

### 无法切换分支

- 检查是否有本地未提交的更改
- 工具会自动执行 `git stash`，但建议提前提交或暂存更改

### 找不到配置文件

- 确认在项目根目录执行命令
- 检查 `appConfig` 文件夹是否存在
- 查看浏览器控制台错误信息

## 📞 技术支持

如有问题，请查看：
- 项目 README.md
- 浏览器控制台错误信息
- 终端日志输出

## 📝 命令行参考

### 基本命令

```bash
# 查看版本号
app-config --version
app-config -v

# 查看帮助信息
app-config --help
app-config -h

# 启动服务（默认端口 3000）
app-config serve

# 启动服务并指定端口
app-config serve --port 8080
app-config serve -p 8080

# 查看 serve 命令的详细帮助
app-config serve --help
```

### 更新工具

```bash
# 更新到最新版本
npm install -g app-config-cli@latest

# 更新到指定版本
npm install -g app-config-cli@1.0.12

# 查看当前安装的版本
app-config --version

# 查看所有可用版本
npm view app-config-cli versions

# 查看最新版本信息
npm view app-config-cli version
```

---

**当前版本**：1.0.12  
**最后更新**：2025-01-XX

